---
// Component Script (inside frontmatter fence)
import MainLayout from './MainLayout.astro';
import PageMetadata from '../components/PageMetadata.astro';
import SupabaseComments from '../components/SupabaseComments';
import AnalyticsTracker from '../components/AnalyticsTracker';
import EssayStatsDisplay from '../components/EssayStatsDisplay';
import { base } from '../utils/constants';
import { getReadingMetrics } from '../utils/readingMetrics';

// For markdown files using this as a layout,
// Astro.props contains frontmatter and renders the markdown content in <slot />
const { frontmatter, rawContent } = Astro.props;
const metrics =
  typeof rawContent === 'function'
    ? getReadingMetrics(rawContent())
    : { wordCount: 0, readTimeMinutes: 1 };

// Extract slug from URL for comments
const slug = Astro.url.pathname.split('/').pop() || 'unknown';

// Create breadcrumb items for this essay
const breadcrumbItems = [
  {
    title: 'Essays',
    url: `${base}essays`,
  },
  {
    title: frontmatter.title,
    url: Astro.url.pathname,
    isCurrent: true,
  },
];

// Structured data for SEO/GEO
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: frontmatter.title,
  description: frontmatter.description,
  author: {
    '@type': 'Person',
    name: 'Chizubo',
    url: 'https://mienstream.com/about',
  },
  publisher: {
    '@type': 'Organization',
    name: "Chizubo's Essays and Research",
    url: 'https://mienstream.com',
  },
  datePublished: frontmatter.dateCreated,
  dateModified: frontmatter.dateUpdated,
  wordCount: metrics.wordCount,
  timeRequired: `PT${metrics.readTimeMinutes}M`,
  keywords: frontmatter.tags?.join(', '),
  articleSection: frontmatter.category,
  url: `https://mienstream.com${Astro.url.pathname}`,
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://mienstream.com${Astro.url.pathname}`,
  },
};
---

<MainLayout
  title={frontmatter.title}
  description={frontmatter.description}
  breadcrumbItems={breadcrumbItems}
>
  <!-- Structured Data for SEO/GEO -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />

  <!-- Analytics Tracker -->
  <AnalyticsTracker
    client:load
    pagePath={Astro.url.pathname}
    pageTitle={frontmatter.title}
    essaySlug={slug}
    enableReadingTracking={true}
  />

  <!-- Essay Header - Mobile optimized -->
  <div class="mb-8 sm:mb-12">
    <h1 class="text-3xl sm:text-4xl font-bold mb-4 text-center leading-tight">
      {frontmatter.title}
    </h1>

    <div class="mb-8">
      <PageMetadata
        {...frontmatter}
        wordCount={metrics.wordCount}
        readingTime={metrics.readTimeMinutes}
      />

      <!-- Essay view count -->
      <div class="text-center mt-4">
        <EssayStatsDisplay
          client:load
          essayPath={Astro.url.pathname}
          showDetailed={true}
          className="justify-center text-sm text-gray-600 dark:text-gray-400"
        />
      </div>
    </div>
  </div>

  <!-- Essay Content - Responsive prose container -->
  <article class="prose prose-gray dark:prose-invert max-w-none">
    <!-- Mobile-optimized prose styling -->
    <div
      class="prose-headings:scroll-mt-16
      prose-h1:text-2xl sm:prose-h1:text-3xl
      prose-h2:text-xl sm:prose-h2:text-2xl
      prose-h3:text-lg sm:prose-h3:text-xl
      prose-p:leading-relaxed
      prose-img:rounded-lg
      prose-img:shadow-md
      prose-a:text-blue-600
      prose-a:no-underline
      hover:prose-a:underline
      dark:prose-a:text-blue-400
      prose-code:text-sm
      prose-code:bg-gray-100
      dark:prose-code:bg-gray-800
      prose-code:px-1
      prose-code:py-0.5
      prose-code:rounded
      prose-pre:text-sm
      prose-blockquote:border-l-4
      prose-blockquote:border-gray-300
      dark:prose-blockquote:border-gray-600
      prose-blockquote:pl-4
      sm:prose-blockquote:pl-6
      prose-ul:my-4
      prose-ol:my-4
      prose-li:my-1
      prose-table:table-auto
      prose-table:border-collapse
      prose-th:border
      prose-td:border
      prose-th:border-gray-300
      prose-td:border-gray-300
      dark:prose-th:border-gray-600
      dark:prose-td:border-gray-600
      prose-th:px-3
      prose-td:px-3
      prose-th:py-2
      prose-td:py-2"
    >
      <slot />
      <!-- Markdown content gets rendered here -->
    </div>
  </article>

  <!-- Comments Section - Mobile optimized -->
  <div class="mt-12 sm:mt-16">
    <div class="border-t border-gray-200 dark:border-gray-700 pt-8 sm:pt-12">
      <SupabaseComments client:load essaySlug={slug} />
    </div>
  </div>
</MainLayout>

<style>
  /* Mobile-first responsive enhancements */

  /* Ensure images are responsive within prose */
  article img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5rem auto;
  }

  /* Better table handling on mobile */
  @media (max-width: 640px) {
    article table {
      font-size: 0.875rem;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
    }

    article th,
    article td {
      padding: 0.5rem 0.75rem;
    }
  }

  /* Code block improvements for mobile */
  @media (max-width: 640px) {
    article pre {
      font-size: 0.8rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    article :not(pre) > code {
      font-size: 0.8rem;
      word-break: break-word;
    }
  }

  /* Better blockquote spacing on mobile */
  @media (max-width: 640px) {
    article blockquote {
      margin-left: 0;
      margin-right: 0;
      padding-left: 1rem;
      font-size: 0.95rem;
    }
  }

  /* Ensure proper line height for readability */
  article p {
    line-height: 1.75;
  }

  @media (max-width: 640px) {
    article p {
      line-height: 1.6;
    }
  }

  /* Smooth scroll behavior for anchor links */
  html {
    scroll-behavior: smooth;
  }

  /* Focus styles for accessibility */
  article a:focus,
  article a:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
    border-radius: 2px;
  }
</style>
